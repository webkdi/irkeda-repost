const axios = require('axios');
const https = require('https');
const { v4: uuidv4 } = require('uuid');
require('dotenv').config();

let tokenCache = {
    token: null,
    expiresAt: null
};

async function getAccessToken() {
    const currentTime = Date.now();

    // Check if the token is still valid
    if (tokenCache.token && tokenCache.expiresAt > currentTime + 5 * 60 * 1000) {
        return tokenCache.token;
    }

    // If no valid token, request a new one
    const url = 'https://ngw.devices.sberbank.ru:9443/api/v2/oauth';
    const clientId = process.env.GIGACHAT_CLIENT_ID;
    const clientSecret = process.env.GIGACHAT_CLIENT_SECRET;
    const authData = Buffer.from(`${clientId}:${clientSecret}`).toString('base64');
    const rqUID = uuidv4();
    const data = 'scope=GIGACHAT_API_PERS';

    try {
        const response = await axios.post(url, data, {
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Authorization': `Basic ${authData}`,
                'Accept': 'application/json',
                'RqUID': rqUID
            },
            httpsAgent: new https.Agent({ rejectUnauthorized: false })
        });

        // Update the cache with the new token and expiration time
        const expiresIn = 30 * 60 * 1000; // 30 minutes
        tokenCache.token = response.data.access_token;
        tokenCache.expiresAt = currentTime + expiresIn;

        return tokenCache.token;
    } catch (error) {
        console.error('Error fetching access token:', error.response ? error.response.data : error.message);
    }
}

async function generateChatResponse(token, messages) {
    const url = 'https://gigachat.devices.sberbank.ru/api/v1/chat/completions';
    const data = {
        model: "GigaChat",
        messages: messages,
        stream: false,
        repetition_penalty: 1
    };

    try {
        const response = await axios.post(url, data, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            httpsAgent: new https.Agent({ rejectUnauthorized: false }) // Bypass SSL
        });

        const output = response.data.choices[0].message.content;
        return output;
    } catch (error) {
        console.error('Error generating chat response:', error.response ? error.response.data : error.message);
    }
}

// Function to build a role-based message array for GigaChat
function buildMessages(articleText) {
    const systemMessage = {
        role: "system",
        content: '–¢—ã –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –ø–æ —Å–æ—Ü—Å–µ—Ç—è–º. –¢–µ–±–µ –±—É–¥–µ—Ç –¥–∞–Ω [–¢–ï–ö–°–¢]. –ò–∑ [–¢–ï–ö–°–¢] –Ω–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ—Å—Ç –¥–ª—è –¢–µ–ª–µ–≥—Ä–∞–º–∞. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç–æ–π –º–æ–ª–æ–¥–µ–∂–Ω—ã–π —è–∑—ã–∫. –î–æ–±–∞–≤–ª—è–π –Ω–µ–º–Ω–æ–≥–æ –µ–º–æ–¥–∑–∏ –∏ —Å–º–∞–π–ª–∏–∫–æ–≤. –ü–æ—Å—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 900 —Å–∏–º–≤–æ–ª–æ–≤, –≤–∫–ª—é—á–∞—è –ø—Ä–æ–±–µ–ª—ã. –°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –∫—Ä–∞—Å–æ—á–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –ø–æ—Å—Ç–∞. –ü–æ—Ç–æ–º —Ä–µ–∑—é–º–∏—Ä—É–π [–¢–ï–ö–°–¢] –≤ 2-3 –∞–±–∑–∞—Ü–∞—Ö. –ù–ï –¥–æ–±–∞–≤–ª—è–π –∫–æ–≤—ã—á–∫–∏ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞. –ù–ï –ø–∏—à–∏ –ø–æ—Å—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –µ–º–æ–¥–∑–∏. –ü—Ä–∏–º–µ—Ä—ã: [–¢–ï–ö–°–¢] """–£—á–µ–Ω—ã–µ –Ω–∞–∑–≤–∞–ª–∏ –ø—Ä–æ–¥—É–∫—Ç, –ø–æ–º–æ–≥–∞—é—â–∏–π –±–æ—Ä–æ—Ç—å—Å—è —Å –±–æ–ª–µ–∑–Ω—å—é –ü–∞—Ä–∫–∏–Ω—Å–æ–Ω–∞. –ï–≥–æ —Å—Ç–æ–∏—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤ —Ä–∞—Ü–∏–æ–Ω. –£—á–µ–Ω—ã–µ –∏–∑ –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ –û—Å–∞–∫–∏ –≤ –Ø–ø–æ–Ω–∏–∏ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏, —á—Ç–æ –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã –≤ —Å–æ—Å—Ç–∞–≤–µ –±—É—Ä—ã—Ö –º–æ—Ä—Å–∫–∏—Ö –≤–æ–¥–æ—Ä–æ—Å–ª–µ–π –º–æ–≥—É—Ç –∑–∞—â–∏—â–∞—Ç—å –Ω–µ–π—Ä–æ–Ω—ã –æ—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π –ø—Ä–∏ –±–æ–ª–µ–∑–Ω–∏ –ü–∞—Ä–∫–∏–Ω—Å–æ–Ω–∞. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã –≤ –∂—É—Ä–Ω–∞–ª–µ Nutrients. –£—á–µ–Ω—ã–µ –æ–±—ä—è—Å–Ω–∏–ª–∏, —á—Ç–æ –±–æ–ª–µ–∑–Ω—å –ü–∞—Ä–∫–∏–Ω—Å–æ–Ω–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ–º –Ω–µ–π—Ä–æ–Ω–æ–≤ –∏–∑-–∑–∞ —á—Ä–µ–∑–º–µ—Ä–Ω–æ–π –≤—ã—Ä–∞–±–æ—Ç–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–æ—Ä–º –∫–∏—Å–ª–æ—Ä–æ–¥–∞, –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–∞–∫ —Å–≤–æ–±–æ–¥–Ω—ã–µ —Ä–∞–¥–∏–∫–∞–ª—ã (–°–†). –ù–∞–∫–∞–ø–ª–∏–≤–∞—è—Å—å, –°–† –≤—ã–∑—ã–≤–∞—é—Ç –ø—Ä—è–º–æ–µ –æ–∫–∏—Å–ª–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –Ω—É–∫–ª–µ–∏–Ω–æ–≤—ã—Ö –∫–∏—Å–ª–æ—Ç –∏ –±–µ–ª–∫–æ–≤. –°–† —Ç–∞–∫–∂–µ –∏–Ω–¥—É—Ü–∏—Ä—É—é—Ç —Ä–µ–∞–∫—Ü–∏–∏ –±–µ–ª–∫–æ–≤ —Å –¥—Ä—É–≥–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –∫–ª–µ—Ç–∫–∏, –≤—ã–∑—ã–≤–∞—è –∏—Ö —Ä–∞—Å—â–µ–ø–ª–µ–Ω–∏–µ –∏ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π. –ú–Ω–æ–≥–æ—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑–∞–ª–∏, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Ä–∞–¥–∏–∫–∞–ª–æ–≤ –º–æ–∂–Ω–æ –Ω–µ–π—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–∞–º–∏ ‚Äî —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª–µ–∑–Ω—ã–º–∏ –≤–µ—â–µ—Å—Ç–≤–∞–º–∏. –í —Ä–∞–º–∫–∞—Ö –Ω–æ–≤–æ–π —Ä–∞–±–æ—Ç—ã —É—á–µ–Ω—ã–µ —Ä–µ—à–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–≥—É—Ç –ª–∏ –ø–æ–ª–∏—Ñ–µ–Ω–æ–ª—ã (—Ä–∞–∑–Ω–æ–≤–∏–¥–Ω–æ—Å—Ç—å –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–æ–≤), —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ—Å—è –≤ –±—É—Ä—ã—Ö –º–æ—Ä—Å–∫–∏—Ö –≤–æ–¥–æ—Ä–æ—Å–ª—è—Ö Ecklonia cava (–≠–∫–ª–æ–Ω–∏—è –ö–∞–≤–∞), –±–æ—Ä–æ—Ç—å—Å—è —Å –±–æ–ª–µ–∑–Ω—å—é –ü–∞—Ä–∫–∏–Ω—Å–æ–Ω–∞. –î–ª—è —ç—Ç–æ–≥–æ –æ–Ω–∏ –ø—Ä–æ–≤–µ–ª–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –Ω–∞ –º—ã—à–∞—Ö. –ì—Ä—ã–∑—É–Ω–∞–º —Å —ç—Ç–∏–º –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ–º –ø–µ—Ä–æ—Ä–∞–ª—å–Ω–æ –¥–∞–≤–∞–ª–∏ –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã –∏–∑ –≤–æ–¥–æ—Ä–æ—Å–ª–µ–π –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ –æ–¥–Ω–æ–π –Ω–µ–¥–µ–ª–∏. –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–º —Å—Ç–∞–ª–æ —É–ª—É—á—à–µ–Ω–∏–µ –º–æ—Ç–æ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∏—à–µ—á–Ω–∏–∫–∞. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –Ω–∞ –∫–ª–µ—Ç–æ—á–Ω—ã—Ö –∫—É–ª—å—Ç—É—Ä–∞—Ö –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ –ø–æ–∫–∞–∑–∞–ª–∏, —á—Ç–æ –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã —Å–ø–æ—Å–æ–±–Ω—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ñ–µ—Ä–º–µ–Ω—Ç AMPK (–∞–¥–µ–Ω–æ–∑–∏–Ω–º–æ–Ω–æ—Ñ–æ—Å—Ñ–∞—Ç-–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º—É—é –ø—Ä–æ—Ç–µ–∏–Ω–∫–∏–Ω–∞–∑—É), —Ç–∞–∫ –Ω–∞–∑—ã–≤–∞–µ–º—ã–π –≤–Ω—É—Ç—Ä–∏–∫–ª–µ—Ç–æ—á–Ω—ã–π –¥–∞—Ç—á–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏. –≠—Ç–æ –ø–æ–¥–∞–≤–ª—è–µ—Ç –≤—ã—Ä–∞–±–æ—Ç–∫—É –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–æ—Ä–º –∫–∏—Å–ª–æ—Ä–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞—é—Ç —Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ –Ω–µ–π—Ä–æ–Ω–∞–ª—å–Ω—ã—Ö –∫–ª–µ—Ç–æ–∫. –£—á–µ–Ω—ã–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–ª–∏, —á—Ç–æ –ø–æ–ª–∏—Ñ–µ–Ω–æ–ª—ã Ecklonia cava –º–æ–≥—É—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å –±–æ–ª–µ–∑–Ω—å –ü–∞—Ä–∫–∏–Ω—Å–æ–Ω–∞ –∏ —É –ª—é–¥–µ–π. –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —ç—Ç–æ–π –≥–∏–ø–æ—Ç–µ–∑—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è.""" –¢–≤–æ–π –æ—Ç–≤–µ—Ç: –ë—É—Ä—ã–µ –≤–æ–¥–æ—Ä–æ—Å–ª–∏ –ø—Ä–æ—Ç–∏–≤ –±–æ–ª–µ–∑–Ω–∏ –ü–∞—Ä–∫–∏–Ω—Å–æ–Ω–∞ üåä\n\n–£—á—ë–Ω—ã–µ –∏–∑ –Ø–ø–æ–Ω–∏–∏ üáØüáµ —Å–¥–µ–ª–∞–ª–∏ –∫—Ä—É—Ç–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –≤ –±–æ—Ä—å–±–µ —Å –±–æ–ª–µ–∑–Ω—å—é –ü–∞—Ä–∫–∏–Ω—Å–æ–Ω–∞ üß†. –û–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã –≤ –±—É—Ä—ã—Ö –º–æ—Ä—Å–∫–∏—Ö –≤–æ–¥–æ—Ä–æ—Å–ª—è—Ö üåø, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ Ecklonia cava, –º–æ–≥—É—Ç –∑–∞—â–∏—â–∞—Ç—å –Ω–µ–π—Ä–æ–Ω—ã –æ—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π üõ°Ô∏è. –≠—Ç–∏ —Å—É–ø–µ—Ä-–ø–æ–ª–µ–∑–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞ –Ω–µ–π—Ç—Ä–∞–ª–∏–∑—É—é—Ç —Å–≤–æ–±–æ–¥–Ω—ã–µ —Ä–∞–¥–∏–∫–∞–ª—ã üå±, –∫–æ—Ç–æ—Ä—ã–µ –∞—Ç–∞–∫—É—é—Ç –∫–ª–µ—Ç–∫–∏ –∏ –≤—ã–∑—ã–≤–∞—é—Ç –±–æ–ª–µ–∑–Ω—å üß¨.\n\n–í —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–µ –Ω–∞ –º—ã—à–∞—Ö üê≠, –∫–æ—Ç–æ—Ä—ã–º –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –¥–∞–≤–∞–ª–∏ –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã –∏–∑ –≤–æ–¥–æ—Ä–æ—Å–ª–µ–π, —É—á—ë–Ω—ã–µ –∑–∞–º–µ—Ç–∏–ª–∏ —É–ª—É—á—à–µ–Ω–∏–µ –º–æ—Ç–æ—Ä–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π üèÉ. –í –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö üî¨ –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —Ñ–µ—Ä–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–Ω–∏–∂–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –≤—Ä–µ–¥–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤, —Ä–∞–∑—Ä—É—à–∞—é—â–∏—Ö –Ω–µ–π—Ä–æ–Ω—ã üí•. –•–æ—Ç—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –µ—â—ë –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç—Å—è, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –±—É—Ä—ã—Ö –≤–æ–¥–æ—Ä–æ—Å–ª–µ–π –≤ —Ä–∞—Ü–∏–æ–Ω üçΩÔ∏è —É–∂–µ —Å–µ–π—á–∞—Å –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –æ—Ç–ª–∏—á–Ω—ã–º —à–∞–≥–æ–º –¥–ª—è –∑–∞—â–∏—Ç—ã –º–æ–∑–≥–∞ –∏ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏ –±–æ–ª–µ–∑–Ω–∏ –ü–∞—Ä–∫–∏–Ω—Å–æ–Ω–∞ üí°.\n\n–¢–∞–∫ —á—Ç–æ, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —á—Ç–æ-—Ç–æ –ø–æ–ª–µ–∑–Ω–æ–µ –≤ —Å–≤–æ—ë –ø–∏—Ç–∞–Ω–∏–µ, –æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —ç—Ç–∏ —á—É–¥–æ-–≤–æ–¥–æ—Ä–æ—Å–ª–∏! üíö'
    };

    const userMessage = {
        role: "user",
        content: `[–¢–ï–ö–°–¢] ${articleText}`
    };

    return [systemMessage, userMessage];
}

function buildTitlePrompt(articleText) {
    const systemMessage = {
        role: "system",
        content: '–¢—ã –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –ø–æ —Å–æ—Ü—Å–µ—Ç—è–º. –¢–µ–±–µ –±—É–¥–µ—Ç –¥–∞–Ω [–¢–ï–ö–°–¢]. –ò–∑ [–¢–ï–ö–°–¢] –Ω–∞–ø–∏—à–∏ —è—Ä–∫–∏–π, –≤—ã–∑—ã–≤–∞—é—â–∏–π –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫, –æ—Ç 1 –¥–æ –º–∞–∫—Å–∏–º—É–º 3 —Å–ª–æ–≤. –ù–ï 4 –∏ –±–æ–ª–µ–µ —Å–ª–æ–≤! –ü—Ä–∏–º–µ—Ä: [–¢–ï–ö–°–¢] """–ë—É—Ä—ã–µ –≤–æ–¥–æ—Ä–æ—Å–ª–∏ –ø—Ä–æ—Ç–∏–≤ –±–æ–ª–µ–∑–Ω–∏ –ü–∞—Ä–∫–∏–Ω—Å–æ–Ω–∞ üåä\n\n–£—á—ë–Ω—ã–µ –∏–∑ –Ø–ø–æ–Ω–∏–∏ üáØüáµ —Å–¥–µ–ª–∞–ª–∏ –∫—Ä—É—Ç–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –≤ –±–æ—Ä—å–±–µ —Å –±–æ–ª–µ–∑–Ω—å—é –ü–∞—Ä–∫–∏–Ω—Å–æ–Ω–∞ üß†. –û–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã –≤ –±—É—Ä—ã—Ö –º–æ—Ä—Å–∫–∏—Ö –≤–æ–¥–æ—Ä–æ—Å–ª—è—Ö üåø, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ Ecklonia cava, –º–æ–≥—É—Ç –∑–∞—â–∏—â–∞—Ç—å –Ω–µ–π—Ä–æ–Ω—ã –æ—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π üõ°Ô∏è. –≠—Ç–∏ —Å—É–ø–µ—Ä-–ø–æ–ª–µ–∑–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞ –Ω–µ–π—Ç—Ä–∞–ª–∏–∑—É—é—Ç —Å–≤–æ–±–æ–¥–Ω—ã–µ —Ä–∞–¥–∏–∫–∞–ª—ã üå±, –∫–æ—Ç–æ—Ä—ã–µ –∞—Ç–∞–∫—É—é—Ç –∫–ª–µ—Ç–∫–∏ –∏ –≤—ã–∑—ã–≤–∞—é—Ç –±–æ–ª–µ–∑–Ω—å üß¨.\n\n–í —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–µ –Ω–∞ –º—ã—à–∞—Ö üê≠, –∫–æ—Ç–æ—Ä—ã–º –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –¥–∞–≤–∞–ª–∏ –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã –∏–∑ –≤–æ–¥–æ—Ä–æ—Å–ª–µ–π, —É—á—ë–Ω—ã–µ –∑–∞–º–µ—Ç–∏–ª–∏ —É–ª—É—á—à–µ–Ω–∏–µ –º–æ—Ç–æ—Ä–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π üèÉ. –í –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö üî¨ –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —Ñ–µ—Ä–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–Ω–∏–∂–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –≤—Ä–µ–¥–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤, —Ä–∞–∑—Ä—É—à–∞—é—â–∏—Ö –Ω–µ–π—Ä–æ–Ω—ã üí•. –•–æ—Ç—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –µ—â—ë –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç—Å—è, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –±—É—Ä—ã—Ö –≤–æ–¥–æ—Ä–æ—Å–ª–µ–π –≤ —Ä–∞—Ü–∏–æ–Ω üçΩÔ∏è —É–∂–µ —Å–µ–π—á–∞—Å –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –æ—Ç–ª–∏—á–Ω—ã–º —à–∞–≥–æ–º –¥–ª—è –∑–∞—â–∏—Ç—ã –º–æ–∑–≥–∞ –∏ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏ –±–æ–ª–µ–∑–Ω–∏ –ü–∞—Ä–∫–∏–Ω—Å–æ–Ω–∞ üí°.\n\n–¢–∞–∫ —á—Ç–æ, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —á—Ç–æ-—Ç–æ –ø–æ–ª–µ–∑–Ω–æ–µ –≤ —Å–≤–æ—ë –ø–∏—Ç–∞–Ω–∏–µ, –æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —ç—Ç–∏ —á—É–¥–æ-–≤–æ–¥–æ—Ä–æ—Å–ª–∏! üíö""" –¢–≤–æ–π –æ—Ç–≤–µ—Ç: –í–æ–¥–æ—Ä–æ—Å–ª–∏ –ø—Ä–æ—Ç–∏–≤ –ü–∞—Ä–∫–∏–Ω—Å–æ–Ω–∞'
    };

    const userMessage = {
        role: "user",
        content: `[–¢–ï–ö–°–¢] ${articleText}`
    };

    return [systemMessage, userMessage];
}

async function getPostOutOfArticle(articleText) {
    const token = await getAccessToken();
    const messages = buildMessages(articleText);
    if (token) {
        const res = await generateChatResponse(token, messages);
        console.log(res);
        return res;
    }
}

// Exported function to be used in other modules
async function getTitleOutIfPost(articleText) {
    const token = await getAccessToken();
    const messages = buildTitlePrompt(articleText);
    if (token) {
        const res = await generateChatResponse(token, messages);
        console.log(res);
        return res;
    }
}

module.exports = { getPostOutOfArticle, getTitleOutIfPost };